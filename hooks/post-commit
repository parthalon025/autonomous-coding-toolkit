#!/usr/bin/env bash
# post-commit — Auto-import new lesson .md files committed to docs/lessons/ into lessons-db,
# then run the post-commit evaluator to record heeded/recurrence outcomes.
# Installed to .git/hooks/post-commit by install.sh
set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"

new_lessons=$(git diff HEAD~1 --name-only --diff-filter=A 2>/dev/null | grep "^docs/lessons/.*\.md$" | grep -vE "/(ARCHIVED|TEMPLATE|SUMMARY|FRAMEWORK|DIAGNOSTICS|README)\.md$" || true)

if [[ -n "${new_lessons}" ]]; then
    if ! command -v lessons-db &>/dev/null; then
        echo "[lessons-db] not installed — skipping auto-import" >&2
    else
        while IFS= read -r lesson_file; do
            echo "[lessons-db] importing: ${lesson_file}"
            lessons-db import "${REPO_ROOT}/${lesson_file}" 2>&1 || echo "[lessons-db] import failed for ${lesson_file} — skipping" >&2
        done <<< "${new_lessons}"
    fi
fi

# Run post-commit evaluator to record heeded/recurrence outcomes
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "${HOOK_DIR}/post-commit-evaluator.sh" ]]; then
    bash "${HOOK_DIR}/post-commit-evaluator.sh" || true
fi
